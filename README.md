# üß∫ Hostel Laundry Bot

A Telegram bot designed to manage hostel laundry room availability, set timers, and facilitate communication between students. Built with Python (FastAPI) and Supabase.

## ‚ú® Features

- **QR Code Scanning**: Deep linking allows users to scan a QR code on a machine to instantly open its control panel
- **Live Status**: Real-time dashboard of all Washers and Dryers (Running/Available/Finished)
- **Smart Timers**:
  - Set 30m/60m timers
  - Receive notifications 5 minutes before completion
  - Receive a "Laundry Done" alert when finished
- **Context Awareness**: Supports multiple laundry levels (Level 9 & 17)
- **Social Pinging**:
  - If a machine is finished but not emptied, users can "Ping" the owner
  - Includes rate-limiting (cooldowns) to prevent spam
- **State Recovery**: Timers persist across server restarts (Hydration architecture)

## üõ†Ô∏è Tech Stack

- **Language**: Python 3.13+
- **Framework**: FastAPI (Web Server) + python-telegram-bot (Bot Logic)
- **Database**: Supabase (PostgreSQL)
- **Deployment**: Render (Web Service)

## üöÄ Getting Started

### Prerequisites

- Python 3.13+ installed
- A Telegram Bot Token (from @BotFather)
- A Supabase Project (Free tier is sufficient)

### 1. Local Installation

Clone the repository and install dependencies:

```bash
git clone git@github.com:Acacia-AI-Society/laundry_bot.git
cd laundry_bot
pip install -r requirements.txt
```

### 2. Environment Setup

Create a `.env` file in the root directory:

```env
TOKEN="your_telegram_bot_token"
ADMIN_IDS=[12345678]
SUPABASE_URL="https://your-project.supabase.co"
SUPABASE_SECRET_KEY="your_service_role_key"
```

**Note**: Get .env details from josh

### 3. Database Setup (Supabase)

Go to the SQL Editor in your Supabase dashboard and run the following schema:

```sql
-- 1. Users Table
create table if not exists users (
  id bigint primary key,
  username text,
  first_name text,
  display_name text,
  level text,
  house text,
  created_at timestamptz default now()
);

-- 2. Machines Table
create table if not exists machines (
  id text primary key,
  type text not null,
  level text not null,
  status text default 'Available',
  start_time timestamptz,
  end_time timestamptz,
  current_user_id bigint references users(id),
  last_user_id bigint references users(id),
  last_ping timestamptz -- Tracks cooldowns
);

-- 3. Audit Logs
create table if not exists audit_logs (
  id bigint generated by default as identity primary key,
  event text not null,
  machine_id text,
  victim_id bigint,
  offender_id bigint,
  timestamp timestamptz default now()
);

-- 4. Enable RLS (Security)
alter table users enable row level security;
create policy "Public cannot read users" on users for select to anon using (false);

-- 5. Seed Data (Levels 9 and 17)
do $$
declare
  lvl text;
  i int;
begin
  foreach lvl in array array['9', '17'] loop
    -- Create 5 Washers & 4 Dryers per level
    for i in 1..5 loop
      insert into machines (id, type, level) 
      values (lvl || '_washer_' || i, 'Washer', lvl) 
      on conflict (id) do nothing;
    end loop;
    for i in 1..4 loop
      insert into machines (id, type, level) 
      values (lvl || '_dryer_' || i, 'Dryer', lvl) 
      on conflict (id) do nothing;
    end loop;
  end loop;
end $$;
```

### 4. Running Locally

To run the bot in Polling Mode (easiest for development):

```bash
uvicorn main:app --reload
# OR
python main.py
```

Open Telegram and send `/start` to your bot.

## ‚òÅÔ∏è Deployment (Render)

1. Create a Web Service on Render connected to this repo
2. **Build Command**: `pip install -r requirements.txt`
3. **Start Command**: `uvicorn main:app --host 0.0.0.0 --port $PORT`
4. **Environment Variables**: Add the 4 variables from your `.env` file to Render
5. **Set Webhook**: Once deployed, open your browser and visit:
   ```
   https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook?url=https://<YOUR_RENDER_URL>/webhook
   ```

## üìÇ Project Structure

- **`main.py`**: Entry point. Handles FastAPI setup, webhook routing, and startup/shutdown events
- **`handlers.py`**: Contains all Telegram command logic (`/start`, `/menu`), button handling, and notification job logic
- **`services.py`**: Database abstraction layer. All Supabase interaction happens here
- **`config.py`**: Loads environment variables safely

---

Made with ‚ù§Ô∏è for hostel students